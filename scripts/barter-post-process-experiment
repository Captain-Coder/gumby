#!/bin/bash
set -e

if test $# -ne 2; then
    echo "Usage: $0 <experiment-config> <peer-directory>"
    exit 1
fi

cd $2
PD=$(pwd)
cd - >/dev/null # return to initial directory
ID=$PWD
EXPERIMENT_CONFIG=$1

cd $PD
mkdir -p output/resource_usage
cd control
for RES_FILE in */output/resource_usage.log; do
    NODE_NAME=$( echo $RES_FILE | cut -f1 -d/ )
    cp -L "$RES_FILE" "../output/resource_usage/$NODE_NAME.log"
done
cd $ID

./barter-experiment-analysis $EXPERIMENT_CONFIG $PD
if test $? -ne 0; then
    exit 2
fi
echo "* Generating graphs..."
./barter-generate-graphs $PD | gnuplot
echo "* Done."

